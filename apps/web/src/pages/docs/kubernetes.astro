---
import DocsLayout from "../../layouts/DocsLayout.astro";
import Callout from "../../components/docs/Callout.astro";
import CodeBlock from "../../components/docs/CodeBlock.astro";
import Steps from "../../components/docs/Steps.astro";
import Step from "../../components/docs/Step.astro";
---

<DocsLayout title="Kubernetes Deployment">
  <h1>Kubernetes Deployment</h1>

  <p>
    Deploy AI Stack to a Kubernetes cluster for production-grade scalability and
    reliability.
  </p>

  <Callout type="note" title="Prerequisites">
    <ul>
      <li>A running Kubernetes cluster (EKS, GKE, AKS, or Minikube)</li>
      <li><code>kubectl</code> installed and configured</li>
      <li>Docker registry access (Docker Hub, ECR, GCR)</li>
    </ul>
  </Callout>

  <Steps>
    <Step title="Build and Push Images">
      <p>
        Build and push the backend and frontend images to your container
        registry:
      </p>
      <CodeBlock
        code={`# Backend
docker build -t your-registry/ai-stack-backend:latest ./apps/backend
docker push your-registry/ai-stack-backend:latest

# Frontend
docker build -t your-registry/ai-stack-frontend:latest ./apps/frontend
docker push your-registry/ai-stack-frontend:latest`}
        lang="bash"
      />
    </Step>

    <Step title="Create Secrets">
      <p>
        Create a Kubernetes Secret for your sensitive environment variables:
      </p>
      <CodeBlock
        code={`apiVersion: v1
kind: Secret
metadata:
  name: ai-stack-secrets
  namespace: default
type: Opaque
stringData:
  OPENAI_API_KEY: "sk-your-api-key"
  DATABASE_URL: "postgresql+asyncpg://user:pass@host:5432/db"
  QDRANT_API_KEY: "your-qdrant-api-key"
  CLERK_SECRET_KEY: "sk_live_your-clerk-secret"`}
        lang="yaml"
        filename="secrets.yaml"
      />
      <CodeBlock code="kubectl apply -f secrets.yaml" lang="bash" />
    </Step>

    <Step title="Deploy Backend">
      <CodeBlock
        code={`apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-stack-backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: your-registry/ai-stack-backend:latest
        ports:
        - containerPort: 8000
        envFrom:
        - secretRef:
            name: ai-stack-secrets
        env:
        - name: LLM_PROVIDER
          value: "openai"
        - name: VECTOR_DB_PROVIDER
          value: "qdrant"
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "1Gi"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 30
---
apiVersion: v1
kind: Service
metadata:
  name: backend
spec:
  selector:
    app: backend
  ports:
  - port: 80
    targetPort: 8000`}
        lang="yaml"
        filename="backend-deployment.yaml"
      />
    </Step>

    <Step title="Deploy Frontend">
      <CodeBlock
        code={`apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-stack-frontend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: your-registry/ai-stack-frontend:latest
        ports:
        - containerPort: 3000
        env:
        - name: NEXT_PUBLIC_API_URL
          value: "http://backend"
        resources:
          requests:
            cpu: "250m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
spec:
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 3000`}
        lang="yaml"
        filename="frontend-deployment.yaml"
      />
    </Step>

    <Step title="Configure Ingress">
      <p>
        Use NGINX Ingress Controller or your cloud provider's Load Balancer:
      </p>
      <CodeBlock
        code={`apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ai-stack-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - ai-stack.example.com
    secretName: ai-stack-tls
  rules:
  - host: ai-stack.example.com
    http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend
            port:
              number: 80
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80`}
        lang="yaml"
        filename="ingress.yaml"
      />
    </Step>
  </Steps>

  <h2>Scaling</h2>

  <p>Scale your deployments based on load:</p>

  <CodeBlock
    code={`# Manual scaling
kubectl scale deployment ai-stack-backend --replicas=4

# Horizontal Pod Autoscaler
kubectl autoscale deployment ai-stack-backend \\
  --cpu-percent=50 \\
  --min=2 \\
  --max=10`}
    lang="bash"
  />

  <Callout type="tip">
    <p>
      Consider using <strong>Helm charts</strong> for easier management and version
      control of your Kubernetes deployments.
    </p>
  </Callout>
</DocsLayout>
