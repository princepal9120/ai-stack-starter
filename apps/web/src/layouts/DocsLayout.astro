---
import Layout from "./Layout.astro";
import { Icon } from "astro-icon/components";
import Header from "../components/common/Header.astro";
import { TableOfContentsWrapper } from "../components/ui/table-of-contents-wrapper";

interface Props {
  title: string;
  description?: string;
}

const { title, description = "" } = Astro.props;

const sidebar = [
  {
    section: "Getting Started",
    links: [{ text: "Quick Start", href: "/docs", icon: "lucide:rocket" }],
  },
  {
    section: "CLI",
    links: [
      { text: "Overview", href: "/docs/cli", icon: "lucide:terminal" },
      {
        text: "Options",
        href: "/docs/cli/options",
        icon: "lucide:sliders-horizontal",
      },
      {
        text: "Prompts",
        href: "/docs/cli/prompts",
        icon: "lucide:message-square",
      },
      {
        text: "Compatibility",
        href: "/docs/cli/compatibility",
        icon: "lucide:shield-check",
      },
      {
        text: "Programmatic API",
        href: "/docs/cli/programmatic-api",
        icon: "lucide:code-2",
      },
    ],
  },
  {
    section: "Guides",
    links: [
      { text: "Overview", href: "/docs/guides", icon: "lucide:book" },
      {
        text: "LLM Providers",
        href: "/docs/guides/llm-providers",
        icon: "lucide:brain-circuit",
      },
      {
        text: "Vector Databases",
        href: "/docs/guides/vector-databases",
        icon: "lucide:database",
      },
      {
        text: "RAG Pipeline",
        href: "/docs/guides/rag-pipeline",
        icon: "lucide:workflow",
      },
      {
        text: "Deployment",
        href: "/docs/guides/deployment",
        icon: "lucide:cloud",
      },
    ],
  },
  {
    section: "Reference",
    links: [
      {
        text: "Project Structure",
        href: "/docs/project-structure",
        icon: "lucide:folder-tree",
      },
      {
        text: "AI Stack Config",
        href: "/docs/ais-config",
        icon: "lucide:settings",
      },
      {
        text: "Analytics",
        href: "/docs/analytics",
        icon: "lucide:bar-chart-3",
      },
    ],
  },
  {
    section: "Community",
    links: [
      {
        text: "Contributing",
        href: "/docs/contributing",
        icon: "lucide:heart",
      },
      { text: "FAQ", href: "/docs/faq", icon: "lucide:help-circle" },
    ],
  },
];

const currentPath = Astro.url.pathname;

// ... (existing flattened links logic) ...
const allLinks = sidebar.flatMap((group) => group.links);
const currentIndex = allLinks.findIndex(
  (link) => currentPath === link.href || currentPath === link.href + "/"
);
const prevLink = currentIndex > 0 ? allLinks[currentIndex - 1] : null;
const nextLink =
  currentIndex < allLinks.length - 1 ? allLinks[currentIndex + 1] : null;

// Current page info
let currentSection = "";
let currentPage = "Introduction";
for (const group of sidebar) {
  for (const link of group.links) {
    if (currentPath === link.href || currentPath === link.href + "/") {
      currentSection = group.section;
      currentPage = link.text;
    }
  }
}
---

<Layout title={`${title} - AI Stack Docs`}>
  <Header activePath="/docs" showSidebarToggle={true} />

  {/* Mobile Sidebar Overlay */}
  <div
    id="mobile-overlay"
    class="fixed inset-0 z-40 bg-slate-950/80 backdrop-blur-sm hidden lg:hidden"
  >
  </div>

  <div class="flex pt-16 h-full min-h-screen">
    {/* Left Sidebar */}
    <aside
      id="sidebar"
      class="fixed left-0 top-16 z-40 h-[calc(100vh-4rem)] w-72 -translate-x-full lg:translate-x-0 overflow-y-auto border-r border-slate-800 bg-slate-950/50 backdrop-blur-sm transition-transform duration-300 ease-in-out scrollbar-thin scrollbar-thumb-slate-800 scrollbar-track-transparent"
    >
      <nav class="px-3 pt-6 pb-10 space-y-8">
        {
          sidebar.map((group) => (
            <div>
              <h3 class="font-semibold text-slate-400 text-xs uppercase tracking-wider mb-2 px-3">
                {group.section}
              </h3>
              <ul class="space-y-0.5">
                {group.links.map((link) => {
                  const isActive =
                    currentPath === link.href ||
                    currentPath === link.href + "/";
                  return (
                    <li>
                      <a
                        href={link.href}
                        class:list={[
                          "group flex items-center gap-2 py-1.5 px-3 text-sm rounded-md transition-all duration-200",
                          isActive
                            ? "text-white bg-white/10 font-medium"
                            : "text-slate-400 hover:text-slate-200 hover:bg-white/5",
                        ]}
                      >
                        <Icon
                          name={link.icon}
                          class:list={[
                            "w-4 h-4 transition-colors",
                            isActive
                              ? "text-white"
                              : "text-slate-500 group-hover:text-slate-400",
                          ]}
                        />
                        {link.text}
                      </a>
                    </li>
                  );
                })}
              </ul>
            </div>
          ))
        }
      </nav>
    </aside>

    {/* Main Content */}
    <main class="flex-1 lg:pl-72">
      <div class="mx-auto max-w-5xl px-6 py-8 lg:px-10">
        {/* Breadcrumbs */}
        <nav
          class="flex items-center gap-2 text-sm text-slate-400 mb-6"
          aria-label="Breadcrumb"
        >
          <a href="/" class="hover:text-white transition">
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              ></path>
            </svg>
          </a>
          <span class="text-slate-600">/</span>
          <a href="/docs" class="hover:text-white transition">Docs</a>
          <span class="text-slate-600">/</span>
          <span class="text-slate-200">{currentPage}</span>
        </nav>

        {/* Content */}
        <article
          class="prose prose-invert prose-slate max-w-3xl
          prose-headings:font-semibold prose-headings:text-white prose-headings:tracking-tight prose-headings:scroll-mt-28
          prose-h1:text-3xl prose-h1:font-bold prose-h1:mb-6 prose-h1:mt-0
          prose-h2:text-xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:pb-2 prose-h2:border-b prose-h2:border-slate-800/50
          prose-h3:text-lg prose-h3:mt-8 prose-h3:mb-3 prose-h3:font-medium
          prose-h4:text-base prose-h4:mt-6 prose-h4:mb-2 prose-h4:font-medium
          prose-p:text-slate-300 prose-p:leading-7 prose-p:mb-4
          prose-a:text-slate-200 prose-a:underline prose-a:underline-offset-2 prose-a:decoration-slate-500 hover:prose-a:decoration-slate-300 prose-a:transition-colors
          prose-strong:text-white prose-strong:font-semibold
          prose-code:text-slate-200 prose-code:bg-slate-800/50 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:text-[0.875em] prose-code:before:content-none prose-code:after:content-none prose-code:font-mono prose-code:font-normal
          prose-pre:bg-[#0d1117] prose-pre:border prose-pre:border-slate-800/50 prose-pre:rounded-lg prose-pre:my-6
          prose-ul:text-slate-300 prose-ul:my-4
          prose-ol:text-slate-300 prose-ol:my-4
          prose-li:text-slate-300 prose-li:leading-7 prose-li:my-1 prose-li:marker:text-slate-500
          prose-hr:border-slate-800/50 prose-hr:my-12
          prose-blockquote:border-slate-700 prose-blockquote:text-slate-400 prose-blockquote:font-normal prose-blockquote:not-italic"
        >
          <slot />
        </article>

        {/* Prev/Next Navigation */}
        <nav class="mt-16 pt-8 border-t border-slate-800">
          <div class="flex flex-col sm:flex-row justify-between gap-4">
            {
              prevLink ? (
                <a
                  href={prevLink.href}
                  class="group flex flex-col p-4 border border-slate-800 rounded-xl hover:border-white/20 hover:bg-white/5 transition-all"
                >
                  <span class="text-xs text-slate-500 mb-1">Previous</span>
                  <span class="text-white font-medium group-hover:text-white transition-colors">
                    ← {prevLink.text}
                  </span>
                </a>
              ) : (
                <div />
              )
            }

            {
              nextLink && (
                <a
                  href={nextLink.href}
                  class="group flex flex-col p-4 border border-slate-800 rounded-xl hover:border-white/20 hover:bg-white/5 transition-all text-right sm:items-end"
                >
                  <span class="text-xs text-slate-500 mb-1">Next</span>
                  <span class="text-white font-medium group-hover:text-white transition-colors">
                    {nextLink.text} →
                  </span>
                </a>
              )
            }
          </div>
        </nav>

        {/* Footer */}
        <footer class="mt-12 pt-8 border-t border-slate-800">
          <div class="flex flex-wrap gap-6 text-sm">
            <a
              href={`https://github.com/princepal9120/ai-stack/edit/main/website/src/pages${currentPath === "/docs" || currentPath === "/docs/" ? "/docs/index" : currentPath}.astro`}
              class="flex items-center gap-2 text-slate-400 hover:text-white transition"
              target="_blank"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                ></path>
              </svg>
              Edit this page on GitHub
            </a>
            <a
              href="https://github.com/princepal9120/ai-stack/issues/new"
              class="flex items-center gap-2 text-slate-400 hover:text-white transition"
              target="_blank"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Report an issue
            </a>
          </div>
        </footer>
      </div>
    </main>

    {/* Right Sidebar (TOC) */}
    <aside class="hidden xl:block w-64 shrink-0">
      <div class="sticky top-24 py-8 pr-4 space-y-8">
        <!-- Table of Contents -->
        <TableOfContentsWrapper client:load />

        <div class="pt-6 border-t border-slate-800">
          <h4
            class="text-xs font-medium text-slate-400 uppercase tracking-wider mb-4"
          >
            Community
          </h4>
          <nav class="space-y-2 text-sm text-slate-500">
            <a
              href="https://github.com/princepal9120/ai-stack"
              class="flex items-center gap-2 hover:text-slate-200 transition"
              target="_blank"
            >
              <Icon name="lucide:github" class="w-4 h-4" />
              Star on GitHub
            </a>
            <a
              href="https://github.com/princepal9120/ai-stack/discussions"
              class="flex items-center gap-2 hover:text-slate-200 transition"
              target="_blank"
            >
              <Icon name="lucide:message-circle" class="w-4 h-4" />
              Discussions
            </a>
          </nav>
        </div>
      </div>
    </aside>
  </div>
</Layout>

<script>
  // Mobile sidebar toggle
  const mobileBtn = document.getElementById("mobile-menu-btn");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("mobile-overlay");

  function toggleSidebar() {
    sidebar?.classList.toggle("-translate-x-full");
    overlay?.classList.toggle("hidden");
    document.body.classList.toggle("overflow-hidden");
  }

  mobileBtn?.addEventListener("click", toggleSidebar);
  overlay?.addEventListener("click", toggleSidebar);

  // Close on escape
  document.addEventListener("keydown", (e) => {
    if (
      e.key === "Escape" &&
      !sidebar?.classList.contains("-translate-x-full")
    ) {
      toggleSidebar();
    }
  });
</script>
